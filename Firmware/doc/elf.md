# gkos elf loading #

The MCU used in the gk does not have an MMU i.e. virtual memory support.  It does have an MPU to stop processes accessing other processes' data however there is no simple way to run two binaries linked to the same address.

To circumvent this, gkos uses some linker tricks for usermode programs.  All binaries are statically linked to address 0 and are linked with relocations emitted (ld --emit-relocs/-q option).  At load time (elf_load_fildes() in src/elf.cpp) the size of the combined .text/.data/.rodata section is determined and a memory block of the appropriate size requested.  This can be anywhere in memory but is typically in either AXISRAM or SDRAM due to size constraints.  The executable is then copied there.  By copying the entire executable en bloc all relative relocations are preserved.  The loader then goes through and patches up any absolute relocations by adding on the appropriate base address.

As a further complication, gkos supports the GCC \_\_attribute((hot))\_\_ label to speed up frequently used code tags.  The arm-none-gkos-ld linker places all these sections near the start of the .text section between tags \_\_start\_hot and \_\_end\_hot so they can be found by the loader.  If possible, this section is loaded to ITCM, AXISRAM or SRAM1/2/3 in that order to speed up code execution (loading from SDRAM is relatively slow despite the M7 D-cache).  The problem with this is that relative relocations either from/to the hot section (but not within it) also need to be patched, and ARM Thumb relocations are typically limited to +/- 23 bits for relative relocations.  Given ITCM is at 0x0 in the address map and SDRAM is at 0x60000000 this is not directly possible there trampoline/veneer code is also emitted to support this.

Finally, TLS sections are handled.  The address of the TLS 'template' is stored in the process structure, and then on thread creation this is copied to a new section available per-thread.  To speed up access to the thread pointer in userspace (LE32 access is used using a soft frame pointer), the current thread TLS block address is always available at address 0x30002000 for the M7 and 0x30002004 for the M4.  This address is read-only from userspace.
